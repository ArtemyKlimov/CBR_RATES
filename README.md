### Реализация сервиса, получающего курсы валют из ЦБ РФ за указанную дату


#### Установка
---
**Пререквизиты:**
- IBM WebSphere MQ не ниже 7.1.0.0 (сервер+клиент)
- IBM WebSphere Message Broker не ниже 9.0.0.7
- права администратора (для Windows) или пользователь в группах mqm, mqbrkrs для Linux
- возможность запуска mqsiprofile
- установлена JRE и прописана переменная среды JAVA_HOME (для Wiremock)

**Фаза инсталляции:**
- создать директории для записи Trace-файлов 
C:\BROKER1\LOGS\CBR_RATES, C:\BROKER1\LOGS\TIMER (для Windows)
или 
/BROKER1/LOGS/CBR_RATES, /BROKER1/LOGS/TIMER (для Linux)
- Cоздать локальные очереди для работы компонента. Скрипты создания очередей в файле scripts/MQ.txt
- Создать Configurable Service для работы таймера. Скрипт создания таймера в файле /scripts/TIMRER_CS.bat (для Windows) или scripts/TIMER_CS.sh (для Linux). На Linux сделать файл исполняемым при помощи команды ```$ chmod +x scripts/TIMER_CS.sh```
- При необходимости переопределить свойства потоков:
полный список настроек можно получить, выполнив команду ```$ mqsireadbar -b CBR_RATES.bar -r > fileprops.txt```
- заменить значения переменных  *QUEUE_MANAGER_NAME, QUEUE_NAME, BRKNAME* в файлах скриптов на актуальные значения

| Свойство |Значение по умолчанию |Описание |
|   ------ | ------ |------ |
| net.artemy.cbrrates.DeliverRates#SOME_WS_URL |http://localhost:22223/SetRates|Адрес сервиса для сохранения курсов валют. По умолчанию указан адрес заглушек из директории /MOCKS |
| *.WS_REQUEST_DELAY |5|Интервал в секундах между повторными вызовами WS в случае его недоступности |
| *.MAX_RETRY_COUNT |3|Макс. кол-во попыток повторно вызвать WS в случае его недоступности |
| *.logLevel|2|Параметры с данным суффиксом задают уровни детализации для конкретной точки логирования. Доступные варианты: 1 - частичное логирование, 2 -полное логирование. При иных значениях параметра логирование не осуществляется. |

- Собрать исполняемые .bar-файлы самостоятельно или использовать собранные файлы из директории /BARfiles
- Задеплоить исполняемые файлы в группу исполнения брокера при помощи Toolkit или выполнив команду ```$ mqsideploy -n <BrokerName> -e <ExecutionGroup> -a <File.bar> -m``` Для корретной работы необходимо установить 3 компонента: UTILS.bar, TIMER.bar, CBR_RATES.bar.

**Запуск:**
- Для запуска таймера необходимо поместить сообщение из файла TimeoutControl.xml в MQ-очередь TIMER_INIT.Q . Конфигурируемые параметры таймера:

| Поле |Значение по умолчанию |Описание |
|   ------ | ------ |------ |
| Identifier |CBRRTS|Уникальный идентификатор таймера |
| Action | SET/CANCEL|Необходимое действие: Запуск/остановка таймера |
| StartDate |TODAY|Дата начала работы таймера |
| Count|-1|Кол-во срабатывания таймера. При значении -1 работает до принудительной отмены |
| StartTime|NOW|Время начала работы таймера |
| Interval|86400|Интервал в сек. между срабатыванием таймера |
| AllowOverwrite|TRUE|Смогут ли последующие сообщения перезаписывать настройки |

- запустить заглушку веб-сервиса сохнанения курсов: запустить скрипт MOCKS\runwiremock.bat (на Windows) или MOCKS\runwiremock.sh (на Linux), выполнив перед этим команду ```$ chmod +x MOCKS/runwiremock.sh```. Логи вызова сервиса будут доступны по адресу http://localhost:22223/__admin/requests
- для получения курса в обход таймера, поместить тестовое сообщение из файла TestMessage.txt в очередь scripts/putTestMessage.bat или scripts/putTestMessage.sh. На Linux сделать файл исполняемым при помощи команды ```$ chmod +x scripts/putTestMessage.sh```

